#!/usr/bin/python
 
import bs4 as BeautifulSoup
 
import urllib, urllib2, cookielib, cStringIO, subprocess
import base64
import requests
from PIL import Image
import time
import sys
 
continues = True
result = ""
counting = 0

#i just want to get PHPSESSID informaion....
def get_cookie_by_name(cj, name):
	return [cookie.value for cookie in cj if cookie.name == name][0]
 
while continues == True:
	counting  += 1
	cookiejar = cookielib.CookieJar()
	opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookiejar))

	#change url with your own first!
	f = opener.open("http://www.abc.com/captcha.php")

	#it is very important to get first cookies from the site that we will use it later.
	cookie = get_cookie_by_name(cookiejar, "PHPSESSID")
	html = f.read()
	soup = BeautifulSoup.BeautifulSoup(html)
 
	img = soup.find("img")['src']
	img = img.replace("data:image/png;base64,", "")
	img = base64.decodestring(img)
 
	fh = open("captcha.png", "wb")
	fh.write(img)
	fh.close()
 
	#this will used for clearing dots from image.and sharpening.
	i = Image.open("captcha.png")
	pixels = i.load()
	width, height = i.size
	color = (255, 255, 255)
 
	for x in range(width):
		for y in range(height):
			if pixels[x, y] == (0, 0, 0):
				pixels[x, y] = color
 
	i.save("captcha.png")
 
	#you must tho have gocr, you can download it from web...
	result = subprocess.Popen(["gocr", "captcha.png"], stdout=subprocess.PIPE).communicate()[0][:-1]

	#change url with your own first!
	url = 'http://www.abc.com/captcha.php'
	data = urllib.urlencode({'cametu' : result})
 
	headers={"Cookie" : "spip_session=REPLACE_WITH_YOUR_SESSION_ID;PHPSESSID="+cookie}
 
	req = urllib2.Request(url, data, headers)
	contents = urllib2.urlopen(req).read()
 
	if "failed!" not in contents:
		result = contents
		continues = False

	break

print result
